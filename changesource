#!/bin/bash
# 通用 Linux 换国内源神器（支持 Debian / Ubuntu / Alpine）

[[ $EUID -ne 0 ]] && { echo "请用 sudo 运行！"; exit 1; }

detect_distro() {
    if [ -f /etc/alpine-release ]; then
        echo "alpine"
    elif [ -f /etc/debian_version ]; then
        if grep -qi "ubuntu" /etc/os-release 2>/dev/null || \
           grep -qi "Linux Mint" /etc/os-release 2>/dev/null || \
           grep -qi "Deepin" /etc/os-release 2>/dev/null || \
           grep -qi "Kylin" /etc/os-release 2>/dev/null; then
            echo "ubuntu"
        else
            echo "debian"
        fi
    else
        echo "unknown"
    fi
}

DISTRO=$(detect_distro)

case $DISTRO in
    debian|ubuntu)
        while :; do
            clear
            echo "===================================================="
            echo "    检测到系统：${DISTRO^^} 系列（含衍生版）"
            echo "===================================================="
            echo
            echo "  1) 清华大学 TUNA（最快最稳，强烈推荐！）"
            echo "  2) 阿里云"
            echo "  3) 华为云"
            echo "  4) 中科大"
            echo "  5) 网易 163"
            echo
            echo "  0) 退出"
            echo
            read -p "  请选择要切换的源 [0-5]: " n
            case $n in
                1) SOURCE="https://mirrors.tuna.tsinghua.edu.cn"; NAME="清华大学 TUNA" ;;
                2) SOURCE="https://mirrors.aliyun.com";           NAME="阿里云" ;;
                3) SOURCE="https://repo.huaweicloud.com";         NAME="华为云" ;;
                4) SOURCE="https://mirrors.ustc.edu.cn";          NAME="中科大" ;;
                5) SOURCE="http://mirrors.163.com";               NAME="网易 163" ;;
                0) echo "再见！"; exit 0 ;;
                *) echo "输入错误，请输入 0-5"; sleep 2; continue ;;
            esac

            echo "正在备份原始源..."
            cp /etc/apt/sources.list /etc/apt/sources.list.bak.$(date +%Y%m%d%H%M%S)

            echo "正在写入 $NAME 源..."
            cat > /etc/apt/sources.list << EOF
# $NAME 镜像源（由 changesource 脚本自动生成）
deb $SOURCE/$(. /etc/os-release; echo $UBUNTU_CODENAME 2>/dev/null || echo $VERSION_CODENAME 2>/dev/null || echo "stable") main restricted universe multiverse
deb $SOURCE/$(. /etc/os-release; echo $UBUNTU_CODENAME 2>/dev/null || echo $VERSION_CODENAME 2>/dev/null || echo "stable")-updates main restricted universe multiverse
deb $SOURCE/$(. /etc/os-release; echo $UBUNTU_CODENAME 2>/dev/null || echo $VERSION_CODENAME 2>/dev/null || echo "stable")-backports main restricted universe multiverse
deb $SOURCE/$(. /etc/os-release; echo $UBUNTU_CODENAME 2>/dev/null || echo $VERSION_CODENAME 2>/dev/null || echo "stable")-security main restricted universe multiverse
EOF

            echo "正在更新软件包列表..."
            apt update && echo -e "\n成功！已切换为 $NAME 源，apt 现在应该超快了\n" || echo "源已切换，更新过程网络波动，稍后再试 apt update 即可"
            read -p "按回车继续换其他源，或 Ctrl+C 退出"
        done
        ;;

    alpine)
        while :; do
            clear
            echo "===================================================="
            echo "           检测到系统：Alpine Linux"
            echo "===================================================="
            echo
            echo "  1) 阿里云（最快）"
            echo "  2) 中科大"
            echo "  3) 清华大学 TUNA"
            echo
            echo "  0) 退出"
            echo
            read -p "  请选择要切换的源 [0-3]: " n
            case $n in
                1) REPO="https://mirrors.aliyun.com/alpine" ;;
                2) REPO="https://mirrors.ustc.edu.cn/alpine" ;;
                3) REPO="https://mirrors.tuna.tsinghua.edu.cn/alpine" ;;
                0) echo "再见！"; exit 0 ;;
                *) echo "输入错误"; sleep 2; continue ;;
            esac

            echo "正在备份 /etc/apk/repositories ..."
            cp /etc/apk/repositories /etc/apk/repositories.bak.$(date +%Y%m%d%H%M%S)

            echo "正在写入新源..."
            sed -i "s|http.*/alpine|$REPO|g" /etc/apk/repositories

            echo "正在更新..."
            apk update && echo -e "\nAlpine 源已成功切换！现在 apk 应该非常快了\n"
            read -p "按回车继续，或 Ctrl+C 退出"
        done
        ;;

    *)
        echo "抱歉，当前系统暂不支持自动换源"
        echo "支持的系统：Debian、Ubuntu、Alpine 及其衍生版"
        exit 1
        ;;
esac
